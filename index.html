<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<title>Geo OCR + Backtest Analyzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
body{font-family:system-ui;background:#0f1220;color:white;padding:20px}
input,button{padding:8px;margin:5px}
.box{background:#1a1f38;padding:15px;margin-top:20px;border-radius:10px}
.good{color:#00ff9d}
.bad{color:#ff4d4d}
h3{margin-top:15px}
</style>
</head>
<body>

<h2>ðŸ“¸ Geo OCR + Backtest Engine</h2>

<p>ÃŽncarcÄƒ poza cu meciuri + cote + rezultat (1/X/2):</p>
<input type="file" id="imgInput" accept="image/*">
<h3>Banca iniÈ›ialÄƒ:</h3>
<input type="number" id="bank" placeholder="Ex: 1000">
<button onclick="runOCR()">RuleazÄƒ OCR + Backtest</button>

<div class="box" id="result">Rezultatele vor apÄƒrea aici...</div>

<script>
// --- FuncÈ›ii matematice ---
function poissonRandom(lambda){let L=Math.exp(-lambda),p=1,k=0;while(p>L){k++;p*=Math.random();}return k-1;}
function monteCarlo(xgH,xgA,sims=100000){let c1=0,cX=0,c2=0;for(let i=0;i<sims;i++){let h=poissonRandom(xgH),a=poissonRandom(xgA);if(h>a)c1++;else if(h==a)cX++;else c2++;}return [c1/sims,cX/sims,c2/sims];}
function kelly(prob,odd){let b=odd-1;let edge=(prob*(b+1)-1)/b;return edge>0?edge*0.5:0;}

// --- OCR + parse + analizÄƒ ---
function runOCR(){
  let file=document.getElementById("imgInput").files[0];
  let bank=parseFloat(document.getElementById("bank").value);
  if(!file||!bank){alert("Alege poza È™i banca iniÈ›ialÄƒ"); return;}
  result.innerHTML="Se proceseazÄƒ OCR...â³";

  Tesseract.recognize(file,'eng',{logger:m=>console.log(m)}).then(({data:{text}})=>{
    processText(text,bank);
  });
}

function processText(text,bank){
  let lines=text.split("\n").map(l=>l.trim()).filter(l=>l.length>0);
  let output="";
  let leagueStats={};
  let initialBank=bank;

  for(let l of lines){
    // Detect liga optional: [EPL], [LaLiga] etc.
    let leagueMatch=l.match(/\[([a-zA-Z0-9\s]+)\]/);
    let league=leagueMatch?leagueMatch[1]:"Unknown";

    // Caut pattern: TeamA odd1 X oddX TeamB odd2 rezultat
    let m=l.match(/(\w+)\s+([\d.]+)\s+X\s+([\d.]+)\s+(\w+)\s+([\d.]+)\s+([1X2])/i);
    if(!m) continue;
    let teamA=m[1], odd1=parseFloat(m[2]), oddX=parseFloat(m[3]), teamB=m[4], odd2=parseFloat(m[5]), resultReal=m[6].toUpperCase();

    // Simplificare xG: invers cota
    let xgH=1/odd1*2.5;
    let xgA=1/odd2*2.5;

    let probs=monteCarlo(xgH,xgA);
    let edge=[probs[0]-1/odd1,probs[1]-1/oddX,probs[2]-1/odd2];
    let bestIndex=edge.indexOf(Math.max(...edge));
    let pick=["1","X","2"][bestIndex];
    let stake=kelly(probs[bestIndex],[odd1,oddX,odd2][bestIndex]);

    // filtrare edge < 4%
    if(edge[bestIndex]<0.04 || stake<=0){stake=0;}

    // max 2% bancÄƒ
    stake=Math.min(stake,bank*0.02);

    // aplicare bet
    if(stake>0){
      if(pick==resultReal) bank+=stake*[odd1,oddX,odd2][bestIndex]-stake;
      else bank-=stake;
    }

    if(!leagueStats[league]) leagueStats[league]={bets:0,valueBets:0,profit:0};
    leagueStats[league].bets++;
    if(stake>0){
      leagueStats[league].valueBets++;
      leagueStats[league].profit+=(pick==resultReal? [odd1,oddX,odd2][bestIndex]-1:-1)*stake;
    }

    let cls=stake>0?"good":"bad";
    output+=`<p class="${cls}">
      [${league}] ${teamA} vs ${teamB} | Pick: ${pick} | Prob: ${(probs[bestIndex]*100).toFixed(2)}% | Edge: ${(edge[bestIndex]*100).toFixed(2)}% | Stake: ${stake.toFixed(2)}
    </p>`;
  }

  // Statistici pe ligÄƒ
  output+="<h3>ðŸ“Š Statistici pe LigÄƒ</h3>";
  for(let l in leagueStats){
    let roi=(leagueStats[l].profit/initialBank*100).toFixed(2);
    output+=`<p>${l} | Total Meciuri: ${leagueStats[l].bets} | Value Bets: ${leagueStats[l].valueBets} | Profit: ${leagueStats[l].profit.toFixed(2)} | ROI: ${roi}%</p>`;
  }

  let totalProfit=(bank-initialBank).toFixed(2);
  let totalROI=((bank-initialBank)/initialBank*100).toFixed(2);
  output+=`<h3>Total Profit: ${totalProfit} | ROI: ${totalROI}%</h3>`;

  result.innerHTML=output||"Nu s-au gÄƒsit meciuri valide Ã®n pozÄƒ.";
}
</script>

</body>
</html>